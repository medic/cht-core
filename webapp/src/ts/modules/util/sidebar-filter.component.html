<section class="sidebar-filter">
  <div 
    class="sidebar-backdrop" 
    [ngClass]="{ hidden: !isOpen }" 
    (click)="toggleSidebarFilter()" 
    (keydown)="($event.key === 'Enter' || $event.key === ' ') && toggleSidebarFilter()"
  ></div>

  <div class="sidebar-main" [ngClass]="{ hidden: !isOpen }">
    <div class="sidebar-header">
      <p class="sidebar-title">{{ 'sidebar.filter.title' | translate }}</p>
      <a class="sidebar-reset" [class.disabled]="disabled" (click)="resetFilters()">{{ 'sidebar.filter.reset' | translate }}</a>
      <a class="sidebar-close" (click)="toggleSidebarFilter()">
        <mat-icon svgIcon="icon-close"></mat-icon>
      </a>
    </div>

    <div class="sidebar-body">
      <mat-accordion multi>
        <!-- 1. Form Type -->
        <mat-expansion-panel id="form-filter-accordion" *ngIf="activeFilters.formType">
          <mat-expansion-panel-header>
            <ng-container
              [ngTemplateOutlet]="headerTemplate"
              [ngTemplateOutletContext]="{
                numSelected: filterCount.formFilter,
                label: 'sidebar.filter.form_type',
                filters: [ 'formFilter' ]
              }">
            </ng-container>
          </mat-expansion-panel-header>
          <mat-panel-description>
            <mm-form-type-filter
              class="filter"
              fieldId="formFilter"
              (search)="applyFilters()"
              [disabled]="disabled">
            </mm-form-type-filter>
          </mat-panel-description>
        </mat-expansion-panel>

        <!-- 2. Place -->
        <mat-expansion-panel  id="place-filter-accordion" *ngIf="activeFilters.place">
          <mat-expansion-panel-header>
            <ng-container
              [ngTemplateOutlet]="headerTemplate"
              [ngTemplateOutletContext]="{
                numSelected: filterCount.placeFilter,
                label: 'sidebar.filter.place',
                filters: [ 'placeFilter' ]
              }">
            </ng-container>
          </mat-expansion-panel-header>
          <mat-panel-description>
            <mm-facility-filter
              class="filter"
              fieldId="placeFilter"
              (search)="applyFilters()"
              [disabled]="disabled">
            </mm-facility-filter>
          </mat-panel-description>
        </mat-expansion-panel>

        <!-- 3. Date -->
        <mat-expansion-panel  id="date-filter-accordion" *ngIf="activeFilters.date" [class.filter-error]="dateFilterError">
          <mat-expansion-panel-header>
            <ng-container
              [ngTemplateOutlet]="headerTemplate"
              [ngTemplateOutletContext]="{
                numSelected: (filterCount.fromDateFilter || 0) + (filterCount.toDateFilter || 0),
                label: 'sidebar.filter.date',
                filters: [ 'fromDateFilter', 'toDateFilter' ]
              }">
            </ng-container>
          </mat-expansion-panel-header>
          <mat-panel-description>
            <label [for]="'fromDateFilter-' + type">{{ 'sidebar.filter.from_date' | translate }}</label>
            <mm-date-filter
              #fromDate
              class="filter"
              [fieldId]="'fromDateFilter-' + type"
              (search)="applyFilters()"
              (onError)="showDateFilterError($event)"
              [disabled]="disabled"
              [isStartDate]="true">
            </mm-date-filter>

            <label [for]="'toDateFilter-' + type">{{ 'sidebar.filter.to_date' | translate }}</label>
            <mm-date-filter
              #toDate
              class="filter"
              [fieldId]="'toDateFilter-' + type"
              (search)="applyFilters()"
              (onError)="showDateFilterError($event)"
              [disabled]="disabled">
            </mm-date-filter>
            <p class="filter-error-message" *ngIf="dateFilterError">{{ dateFilterError | translate }}</p>
          </mat-panel-description>
        </mat-expansion-panel>

        <!-- 4. Status -->
        <mat-expansion-panel id="status-filter-accordion" *ngIf="activeFilters.status">
          <mat-expansion-panel-header>
            <ng-container
              [ngTemplateOutlet]="headerTemplate"
              [ngTemplateOutletContext]="{
                numSelected: filterCount.statusFilter,
                label: 'sidebar.filter.status',
                filters: [ 'statusFilter' ]
              }">
            </ng-container>
          </mat-expansion-panel-header>
          <mat-panel-description>
            <mm-status-filter
              class="filter"
              fieldId="statusFilter"
              (search)="applyFilters()"
              [disabled]="disabled">
            </mm-status-filter>
          </mat-panel-description>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <div class="sidebar-footer">
      <button type="button" class="btn btn-primary" (click)="toggleSidebarFilter()">{{ 'sidebar.filter.submit' | translate }}</button>
    </div>
  </div>
</section>

<ng-template #headerTemplate let-numSelected="numSelected" let-label="label" let-filters="filters">
  <p class="title">{{ label | translate }}</p>
  <div class="chip" *ngIf="numSelected" [class.disabled]="disabled">
    <span>{{ numSelected | translate }}</span>
    <span 
      class="fa fa-times" 
      (click)="clearFilters(filters); $event.stopPropagation();"
      (keydown)="($event.key === 'Enter' || $event.key === ' ') && clearFilters(filters); $event.stopPropagation();"
    ></span>
  </div>
</ng-template>
