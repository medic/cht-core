services:
  couchdb1:
    build:
      context: ..
      target: cht-couchdb
    environment:
      - "COUCHDB_USER=${COUCHDB_USER}"
      - "COUCHDB_PASSWORD=${COUCHDB_PASSWORD}"
      - "COUCHDB_SECRET=${COUCHDB_SECRET:-7CF0C1FA-5940-4381-A4EB-E6F6874BAE83}"
      - "COUCHDB_UUID=${COUCHDB_UUID:-CC686127-22F5-4E80-8DF2-BB3C80A086B8}"
      - "SVC_NAME=couchdb1"
      - "CLUSTER_PEER_IPS=couchdb2,couchdb3"
    networks:
      - couch-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "${COUCHDB_USER}:${COUCHDB_PASSWORD}", "http://localhost:5984/_up"]
      interval: 5s
      timeout: 3s
      retries: 12

  couchdb2:
    build:
      context: ..
      target: cht-couchdb
    environment:
      - "COUCHDB_USER=${COUCHDB_USER}"
      - "COUCHDB_PASSWORD=${COUCHDB_PASSWORD}"
      - "COUCHDB_SECRET=${COUCHDB_SECRET:-7CF0C1FA-5940-4381-A4EB-E6F6874BAE83}"
      - "COUCHDB_UUID=${COUCHDB_UUID:-CC686127-22F5-4E80-8DF2-BB3C80A086B8}"
      - "SVC_NAME=couchdb2"
      - "COUCHDB_SYNC_ADMINS_NODE=${COUCHDB_SYNC_ADMINS_NODE:-couchdb1}"
    networks:
      - couch-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "${COUCHDB_USER}:${COUCHDB_PASSWORD}", "http://localhost:5984/_up"]
      interval: 5s
      timeout: 3s
      retries: 12

  couchdb3:
    build:
      context: ..
      target: cht-couchdb
    environment:
      - "COUCHDB_USER=${COUCHDB_USER}"
      - "COUCHDB_PASSWORD=${COUCHDB_PASSWORD}"
      - "COUCHDB_SECRET=${COUCHDB_SECRET:-7CF0C1FA-5940-4381-A4EB-E6F6874BAE83}"
      - "COUCHDB_UUID=${COUCHDB_UUID:-CC686127-22F5-4E80-8DF2-BB3C80A086B8}"
      - "SVC_NAME=couchdb3"
      - "COUCHDB_SYNC_ADMINS_NODE=${COUCHDB_SYNC_ADMINS_NODE:-couchdb1}"
    networks:
      - couch-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "${COUCHDB_USER}:${COUCHDB_PASSWORD}", "http://localhost:5984/_up"]
      interval: 5s
      timeout: 3s
      retries: 12

  mocha-test:
    image: node:22-alpine
    depends_on:
      couchdb1:
        condition: service_healthy
      couchdb2:
        condition: service_healthy
      couchdb3:
        condition: service_healthy
    volumes:
      - ../../:/app
    working_dir: /app/couchdb/tests
    environment:
      - "COUCHDB_USER=${COUCHDB_USER}"
      - "COUCHDB_PASSWORD=${COUCHDB_PASSWORD}"
    command: >
      sh -c "npm install --no-save && npm test"
    networks:
      - couch-test-network

networks:
  couch-test-network:
    driver: bridge