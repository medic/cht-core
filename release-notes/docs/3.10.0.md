# 3.9.0 Release Notes

- [Known issues](#known-issues)
- [Upgrade notes](#upgrade-notes)
- [Supporting remote first-time login](#supporting-remote-first-time-login)
- [Supporting linked docs](#supporting-linked-docs)
- [Privacy Policies](#privacy-policies)
- [More granular replication depth configuration for offline users](#more-granular-replication-depth-configuration-for-offline-users)
- [Improved geolocation data saved for reports](#improved-geolocation-data-saved-for-reports)
- [Customizable header tabs icons](#customizable-header-tabs-icons)
- [And more...](#and-more)

## Known issues

None.

## Upgrade notes

### Breaking changes

#### Updates to meta databases replication

The replication of users meta databases to the conglomerate, `medic-users-meta` database, is no longer configurable. 
This task now runs every day, at 2am UTC, and replicates `feedback` and `telemetry` documents to `medic-users-meta` database.

#### Android wrapper update required for new features

Several features and improvements in 3.10 are only fully functional while using the latest release of medic-android.

### Supported software

There are no required changes to the [supported software matrix](https://github.com/medic/medic-docs/blob/master/installation/supported-software.md) from `3.0.0`.

| Node | CouchDB | Browsers | SMS bridge | Android | medic-android | medic-couch2pg |
|----|----|----|----|----|----|---|
| 8.11+ | 2.1+ | Chrome 53+, Firefox latest | medic-gateway | 4.4+ | 0.4.5+ ???? | 3.0+ |

// todo medic-android version?? 

#### Supporting remote first-time login

3.10.0 adds a new authentication mechanism that doesn't require users to know their username or password. Users can now access the app for the first time by clicking on a token authentication link that they receive by SMS. Admins can enable or disable the `token_login` for any user. This feature requires the latest version of the `medic-android` app.  
See [the documentation](https://docs.communityhealthtoolkit.org/apps/reference/api/#login-by-sms) for more information.    
// todo picture?

#### Supporting linked docs

To support the ability of configuring sending SMS messages to contacts other than primary contacts of parent places, contact documents now expose a new property, `linked_docs`, that can contain a list of document ids, that are relevant to the respective contact. Every document referenced in `linked_docs` will be shallowly hydrated when the contact is used, and provides a means to access the contents of these related documents everywhere the contact is used within the app.
This feature can have a multitude of applications, from providing a way to access a contact's phone number when resolving a recipient to linking a child person document to the corresponding delivery report, as `linked_docs` can also be used in `contact-summary`.   
//todo documentation link

#### Privacy Policies

App builders can now configure privacy policies for every language. When a privacy policy is configured for a language, users who load the app in this language are prompted to accept the policy, and are blocked from using the app until they have accepted. Privacy policies can be configured using `medic-conf` or from a new App Management page.    
See [the documentation](https://docs.communityhealthtoolkit.org/apps/guides/security/privacy-policy/) for more information.  
// todo picture?

#### More granular replication depth configuration for offline users

This release adds a new `replication_depth` configuration option that limits the depth of replicated reports. This allows app builders to configure roles that replicate deeper contacts, can report against these contacts, but will not download reports about these contacts that have been created by other users.  
See [the documentation](https://docs.communityhealthtoolkit.org/apps/guides/performance/replication/#report-depth) for more information.

#### Improved geolocation data saved for reports

3.10.0 improves the way geolocation information is obtained, from requesting an instant position to allowing up to 30 seconds to get a position lock. Additionally, geolocation is now updated every time a report is edited, and the all previous geolocation data is saved in a log within the same report.
This change also supports the latest updates in `medic-android`, so Location permissions are requested at runtime, rather than demanded when starting the app for the first time.   

#### Customizable header tabs icons

As of 3.10.0, header tabs icons can be customized, supporting any [FontAwesome](https://fontawesome.com/v4.7.0/) icon or [resource icon](https://docs.communityhealthtoolkit.org/design/icons/) in SVG format.
Tabs icons can be configured using `medic-conf` or from a new App Management page.  
See [the documentation](https://docs.communityhealthtoolkit.org/apps/reference/app-settings/header_tabs/) for more information.  
// todo picture? 

## And more...

### Features

- [cht-core#5817](https://github.com/medic/cht-core/issues/5817): Ability to configure SMS sending to other contacts that aren't the primary contact
- [cht-core#6339](https://github.com/medic/cht-core/issues/6339): Provide an API endpoint for fetching a contact by phone number
- [cht-core#6352](https://github.com/medic/cht-core/issues/6352): As a data entry clerk I want to access, create, edit people in a place that I can access, and report about them, but not see any of the reports created by others for those contacts.
- [cht-core#6380](https://github.com/medic/cht-core/issues/6380): Support remote first time log in
- [medic-conf#307](https://github.com/medic/medic-conf/issues/307): Add a command line flag to accept all prompts to enable scripted execution

### Improvements

- [cht-core#5917](https://github.com/medic/cht-core/issues/5917): Make sure we are storing all debug / output from android when trying to obtain GPS
- [cht-core#6001](https://github.com/medic/cht-core/issues/6001): Alert when outbound pushes are repeatedly failing
- [cht-core#6094](https://github.com/medic/cht-core/issues/6094): Make configurable, marking of outgoing messages as duplicates
- [cht-core#6396](https://github.com/medic/cht-core/issues/6396): Scoping: Investigate IVR options 
- [cht-core#6401](https://github.com/medic/cht-core/issues/6401): Add ability to hide the action/option to create a contact
- [cht-core#6410](https://github.com/medic/cht-core/issues/6410): Ability to customize icons shown on main tabs (contact, tasks, etc)
- [cht-core#6419](https://github.com/medic/cht-core/issues/6419): Allow you to configure outbound to send the same record multiple times
- [cht-core#6481](https://github.com/medic/cht-core/issues/6481): Allow enough space to show list of forms in Reports Filter. 
- [cht-core#6492](https://github.com/medic/cht-core/issues/6492): Touch area of items in the hamburger menu should be larger
- [cht-core#6516](https://github.com/medic/cht-core/issues/6516): Improve SMS reminders so they can be configured to be sent to places anywhere in the hierarchy
- [cht-core#6538](https://github.com/medic/cht-core/issues/6538): Adhere to play store privacy policy requirements update 
- [medic-conf#273](https://github.com/medic/medic-conf/issues/273): Add configurable hierarchy support to doc references in csv-to-docs

### Performance fixes

- [cht-core#6116](https://github.com/medic/cht-core/issues/6116): Improve the performance of deleting read docs
- [cht-core#6276](https://github.com/medic/cht-core/issues/6276): Use http2 to fetch all login resources at the same time

### Bug fixes

- [cht-core#6024](https://github.com/medic/cht-core/issues/6024): The outbound error response logging is needlessly verbose
- [cht-core#6121](https://github.com/medic/cht-core/issues/6121): Translations in the App Settings app aren't recognized until you refresh
- [cht-core#6130](https://github.com/medic/cht-core/issues/6130): Reports deleted from webapp interface are saved fully hydrated
- [cht-core#6182](https://github.com/medic/cht-core/issues/6182): Support custom contact types in medic-pyxform
- [cht-core#6313](https://github.com/medic/cht-core/issues/6313): Use the browser language as the default language
- [cht-core#6370](https://github.com/medic/cht-core/issues/6370): Replication "isSensitive" logic prevents "boss" from creating any report for users directly under them in hierarchy
- [cht-core#6386](https://github.com/medic/cht-core/issues/6386): Error on report not cleared
- [cht-core#6404](https://github.com/medic/cht-core/issues/6404): User name autofilled with "medic" 
- [cht-core#6433](https://github.com/medic/cht-core/issues/6433): Infinite spinners when loading tabs as admin
- [cht-core#6502](https://github.com/medic/cht-core/issues/6502): Guided tour erratic when user has no access to any tab
- [cht-core#6519](https://github.com/medic/cht-core/issues/6519): Upgrading doesn't apply replication configuration which means `users-meta` is empty
- [cht-core#6562](https://github.com/medic/cht-core/issues/6562): Muso production users have multiple task documents in non-terminal state with the same emission id
- [cht-core#6567](https://github.com/medic/cht-core/issues/6567): Security issue medic-infrastructure#147
- [cht-core#6568](https://github.com/medic/cht-core/issues/6568): Security issue medic-infrastructure#190
- [cht-core#6575](https://github.com/medic/cht-core/issues/6575): Large grey banner shown above content on mobile
- [cht-core#6578](https://github.com/medic/cht-core/issues/6578): Wrong error message shown when editing a user that replicates too many docs
- [cht-core#6582](https://github.com/medic/cht-core/issues/6582): Scheduled messages with due date of `null` end up being processed over and over without being updated
- [cht-core#6583](https://github.com/medic/cht-core/issues/6583): Users are forced to login one year after they last logged in
- [horticulturalist#57](https://github.com/medic/horticulturalist/issues/57): Horti doesn't wam all views when deploying 3.9.x+
- [medic-conf#290](https://github.com/medic/medic-conf/issues/290): Tests fail locally when Bash completion is not setup
- [medic-conf#315](https://github.com/medic/medic-conf/issues/315): Error running csv-to-docs with null properties
- [medic-conf#322](https://github.com/medic/medic-conf/issues/322): Missing optional appliesIf attribute on contact summary cards causes crash
- [medic-conf#332](https://github.com/medic/medic-conf/issues/332): Uploading of multimedia is extremely limited in medic-conf

### Technical issues

- [cht-core#6369](https://github.com/medic/cht-core/issues/6369): Detect unhandled rejections in unit tests
- [cht-core#6379](https://github.com/medic/cht-core/issues/6379): Figure out how to deploy RapidPro in production
- [cht-core#6439](https://github.com/medic/cht-core/issues/6439): Auth service unit test is flaky
- [cht-core#6463](https://github.com/medic/cht-core/issues/6463): Bump dependencies for 3.10
- [medic-android#111](https://github.com/medic/medic-android/issues/111): Compliance with Play Store developer policies for PII collection disclosure

