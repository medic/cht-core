var updates = require('kujua-sms/updates'),
    lists = require('kujua-sms/lists'),
    logger = require('kujua-utils').logger,
    baseURL = require('duality/core').getBaseURL(),
    appdb = require('duality/core').getDBURL(),
    querystring = require('querystring'),
    jsDump = require('jsDump'),
    fakerequest = require('couch-fakerequest'),
    helpers = require('../../test-helpers/helpers'),
    _ = require('underscore')._;

    
var example = {
    sms_message: {
       from: "+13125551212",
       message: '1!MSBC!2012#1#16#abcdef#5#aaa#31#bbb#ccc#5#ddd#eee',
       sent_timestamp: "1-19-12 18:45",
       sent_to: "+15551212",
       type: "sms_message",
       locale: "en",
       form: "MSBC"
    },
    clinic: {
        "_id": "4a6399c98ff78ac7da33b639ed60f458",
        "_rev": "1-0b8990a46b81aa4c5d08c4518add3786",
        "type": "clinic",
        "name": "Example clinic 1",
        "contact": {
            "name": "Sam Jones",
            "phone": "+17085551212"
        },
        "parent": {
            "type": "health_center",
            "contact": {
                "name": "Neal Young",
                "phone": "+13125551212"
            },
            "parent": {
                "type": "district_hospital",
                "contact": {
                    "name": "Bernie Mac",
                    "phone": "+14155551212"
                }
            }
        }
    }
};

var expected_callback = {
    data: {
        type: "data_record",
        form: "MSBC",
        related_entities: {
            clinic: null
        },
        sms_message: example.sms_message,
        from: "+13125551212",
        refid: "abcdef",
        errors: [],
        tasks: [],
        cref_year: "2012",
        cref_month: "1",
        cref_day: 16,
        cref_rc: "abcdef",
        cref_ptype: "Autre",
        cref_name: "aaa",
        cref_age: 31,
        cref_mom: "bbb",
        cref_treated: "ccc",
        cref_rec: "Référé",
        cref_reason: "ddd",
        cref_agent: "eee"
    }
};


/*
 * STEP 1:
 *
 * Run add_sms and expect a callback to add a clinic to a data record which
 * contains all the information from the SMS.
 **/
exports.msbc1_to_record = function (test) {

    test.expect(32);

    // Data parsed from a gateway POST
    var data = {
        from: '+13125551212',
        message: '1!MSBC!2012#1#16#abcdef#5#aaa#31#bbb#ccc#5#ddd#eee',
        sent_timestamp: '1-19-12 18:45',
        sent_to: '+15551212'
    };

    // request object generated by duality includes uuid and query.form from
    // rewriter.
    var req = {
        uuid: '14dc3a5aa6',
        query: {form: 'MSBC'},
        method: "POST",
        headers: helpers.headers("url", querystring.stringify(data)),
        body: querystring.stringify(data),
        form: data
    };

    var resp = fakerequest.update(updates.add_sms, data, req);

    var resp_body = JSON.parse(resp[1].body);
    delete resp_body.callback.data.reported_date;
    
    test.same(
        resp_body.callback.options.path,
        baseURL + "/MSBC/data_record/add/refid/abcdef");

    _.each([
        'cref_year', 'cref_month', 'cref_day', 'cref_rc',
        'cref_ptype', 'cref_name', 'cref_age', 'cref_mom',
        'cref_treated', 'cref_rec', 'cref_reason', 'cref_agent'
    ], function(attr) {
        test.same(
            resp_body.callback.data[attr],
            expected_callback.data[attr]);
    });

    test.same(
        resp_body.callback.data.sms_message,
        expected_callback.data.sms_message);

    test.same(
        resp_body.callback.data,
        expected_callback.data);

    // form next request from callback data
    var next_req = {
        method: resp_body.callback.options.method,
        body: JSON.stringify(resp_body.callback.data),
        path: resp_body.callback.options.path,
        headers: helpers.headers(
                    'json', JSON.stringify(resp_body.callback.data)),
        query: {form: 'MSBC'}
    };

    step2(test, next_req);

};

//
// STEP 2:
//
// Run data_record/add/clinic and expect a callback to
// check if the same data record already exists.
//
var step2 = function(test, req) {

    var clinic = example.clinic;

    var viewdata = {rows: [
        {
            "key": ["+13125551212"],
            "value": clinic
        }
    ]};

    var resp = fakerequest.list(lists.data_record, viewdata, req);

    var resp_body = JSON.parse(resp.body);

    //
    // For now we do not care for duplicates,
    // so we just check that the data record gets created
    // without merging it with an existing one.
    //
    
    // If no record exists during the merge then we create a new record with
    // POST
    test.same(resp_body.callback.options.method, "POST");
    test.same(resp_body.callback.options.path, appdb);

    // extra checks
    test.same(resp_body.callback.data.errors, []);
    test.same(
        resp_body.callback.data.sms_message,
        example.sms_message);
        
    _.each([
        'cref_year', 'cref_month', 'cref_day', 'cref_rc',
        'cref_ptype', 'cref_name', 'cref_age', 'cref_mom',
        'cref_treated', 'cref_rec', 'cref_reason', 'cref_agent'
    ], function(attr) {
        test.same(
            resp_body.callback.data[attr],
            expected_callback.data[attr]);
    });

    test.same(
        resp_body.callback.data.tasks[0].messages[0].message,
        "Année: 2012, Mois: 1, Jour: 16, Code du RC: abcdef, Type de patient: Autre, Nom: aaa, Age: 31, Nom de la mère ou de l'accompagnant: bbb, Recommandations/Conseils: Référé, Précisions pour recommandations: ddd, Nom de l'agent de santé: eee"
    );    

    test.done();
};