name: Fix Dependabot lockfile

on:
  pull_request:
    paths:
      - '**/package-lock.json'
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch to diff against'
        required: true
        default: 'master'

permissions:
  contents: write

jobs:
  fix-lockfile:
    if: github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      BASE_REF: ${{ github.base_ref || inputs.base_branch }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use Node.js 22.15
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'

      - name: Regenerate lockfiles
        run: |
          git diff --name-only origin/${{ env.BASE_REF }}...HEAD | grep 'package-lock.json' | while read file; do
            dir=$(dirname "$file")
            if [ "$dir" = "." ]; then
              echo "Regenerating root lockfile"
              npm install --package-lock-only --ignore-scripts
            elif [ -f "$dir/package.json" ]; then
              echo "Regenerating $dir lockfile"
              npm install --package-lock-only --ignore-scripts --prefix "$dir"
            fi
          done

      - name: Commit updated lockfiles
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'fix: regenerate package-lock.json'
          file_pattern: '**/package-lock.json'
