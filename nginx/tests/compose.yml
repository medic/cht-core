services:
  cht-nginx:
    build:
      context: ../
      target: cht-nginx
    environment:
      API_HOST: mock-api
      API_PORT: 5988
      CERTIFICATE_MODE: SELF_SIGNED
    volumes:
      - cht-ssl:/root/.acme.sh/
    depends_on:
      - mock-api

  mock-api:
    image: nginx:1-alpine-slim
    volumes:
      - ./mock-config/conf.d/:/etc/nginx/conf.d/:ro

  nginx-tests:
    build:
      context: ../ # Assumes Dockerfile is in the parent directory
      target: test_nginx
    environment:
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
    command: [ "sh", "-c", "echo 'Running in container'; npm test" ]
    depends_on:
      - cht-nginx

volumes:
  cht-ssl:
    name: cht-ssl
